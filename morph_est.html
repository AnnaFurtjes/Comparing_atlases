<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Anna Elisabeth Furtjes" />


<title>Morphometricity estimates</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Overview</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="Serious_Pipeline.html">Neuroimaging pre-processing</a>
</li>
<li>
  <a href="morph_est.html">Morphometricity estimation</a>
</li>
<li>
  <a href="Results.html">Results</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Morphometricity estimates</h1>
<h4 class="author">Anna Elisabeth Furtjes</h4>

</div>


<p><br> <br></p>
<p>The scripts below follow a number of steps using <a href="https://yanglab.westlake.edu.cn/software/osca/#Overview">OSCA</a> which are necessary to fir mixed linear models and obtain morphometricity estimates. Because data structures between atlas data and vertex-wise measures differ, some steps also differ for the analysis of either atlases or vertex-wise measures. The <a href="morph_est.html#Morphometricity_from_atlas_data">first</a> example here is for atlases, and the second example <a href="morph_est.html#Morphometricity_from_vertex-wise_data">below</a> is for vertex-wise measures that require more computation due to large file sizes.</p>
<hr />
<div id="morphometricity-from-atlas-data" class="section level1">
<h1>Morphometricity from atlas data</h1>
<p><br> <br></p>
<div id="make-bod-files" class="section level2">
<h2>1. Make bod files</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=make_bod
#SBATCH --output=~/morphometricity/output/make_bod_%A_%a.out
#SBATCH -D /mnt/lustre/datasets/ukbiobank/ukb40933/imaging/output
#SBATCH --mem-per-cpu=3G 
#SBATCH --array=1-7 # 7 atlases

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morph_results&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_atlases.txt
atlasName=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)

##################################################
### OSCA analyses for brain atlases
### The processing works with the formatting from combine_atlas_output.R
##################################################

for mod in ThickAvg SurfArea GrayVol
do

        ############################################################################
        # MAKE BOD FILES
        # Make binary input files for LMM analyses
        # delete all ROIs/vertices with a SD of zero
        ############################################################################
            
        /users/k1894405/osca_Linux \
        --efile ${wd}/data/atlases/${atlasName}_${mod}_all_* \
        --sd-min 0.000001 \
        --no-fid \
        --make-bod \
        --out ${wd}/data/bod_files/Bod_${atlasName}_${mod}
        #--keep ${wd}/data/indi.list.fid \
        #
            
        echo &quot;Created bod files for $atlasName $mod&quot;
        
        ###########################################################################
        ## OSCA analyses: 
        ## manage bod files to include subset of individuals that all atlases &amp; vertices have in common
        ## Saved in indi.list
        ############################################################################


        /users/k1894405/osca_Linux \
        --befile ${wd}/data/bod_files/Bod_${atlasName}_${mod} \
        --keep ${wd}/data/indi.list.fid \
        --make-bod \
        --out ${wd}/data/bod_files/Bod_${atlasName}_${mod}
        
        echo &quot;Created bod files for $atlasName $mod&quot;
        
done





##### sbatch -p shared,brc ~/morphometricity/scripts/make_bod_files.sh

### This is the first script needed for morphometricity estimates (second is calculate BRM)</code></pre>
<p><br></p>
</div>
<div id="calculate-brain-relatedness-matrix" class="section level2">
<h2>2. Calculate Brain-Relatedness-Matrix</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=calculate_BRM
#SBATCH --output=~/morphometricity/output/calculate_BRM_%A_%a.out
#SBATCH -D /mnt/lustre/datasets/ukbiobank/ukb40933/imaging/output
#SBATCH --mem-per-cpu=40G 
#SBATCH --array=1-7 # 7 atlases

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morph_results&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_atlases.txt
atlasName=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)

echo &quot;Processing &quot; $atlasName

for mod in ThickAvg SurfArea GrayVol
do

        ############################################################################
        # CALCULATE BRAIN-RELATEDNESS-MATRIX
        # orm-alg correspond to algorithm used to estimate BRM: 1 = standardized data of each ROI
        # potentially make-orm-bin or make-orm-gz to save space
        ############################################################################
        
        /users/k1894405/osca_Linux \
        --befile ${wd}/data/bod_files/Bod_${atlasName}_${mod} \
        --make-orm \
        --out ${wd}/data/BRM/BRM_${atlasName}_${mod}
        
        echo &quot;Calculated BRMs for $atlasName $mod&quot;
        
        ############################################################################
        # GET MEAN AND VARIANCE FOR EACH ROI
        ############################################################################
        
        /users/k1894405/osca_Linux \            
        --befile ${wd}/data/bod_files/Bod_${atlasName}_${mod} \
        --get-mean \
        --get-variance \
        --out ${wd}/bod_files/${atlasName}_${mod}_mean_var
        
        echo &quot;Calculated mean and variances for $atlasName $mod&quot;
        
done

/usr/bin/sacct --format=&quot;CPUTime, MaxRSS&quot;

##### sbatch -p brc,shared ~/morphometricity/scripts/calculate_BRM.sh



##### This is the second step to get morphometricity estimates (after making bod files, before calculating morph estimates)</code></pre>
<p><br></p>
</div>
<div id="get-morphometricity-estimate" class="section level2">
<h2>3. Get morphometricity estimate</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=DK_morph_est
#SBATCH --output=~/morphometricity/output/upd_morph_est_DK_%A_%a.out
#SBATCH --mem=80G 
#SBATCH --cpus-per-task=10
#SBATCH --time=2-00:00
#SBATCH --array=1-7 # parallel analysis for 7 phenos

module load apps/R/3.6.0


wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morp_results_update&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;


atlasName=&quot;DK&quot;

echo &quot;Starting morph estimates for &quot; $atlasName

refList=${scripts_dir}/ref_pheno.txt
pheno=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)


for mod in ThickAvg SurfArea GrayVol
do

            # exclude analyses that were already performed
            if [ -f morph_est_${atlasName}_${mod}_${pheno}.rsq ]
            then

                echo &quot;Now executing &quot; $mod $pheno
                
                /users/k1894405/osca_Linux \
                --reml \
                --orm ${wd}/data/BRM/BRM_${atlasName}_${mod} \
                --pheno ${pheno_dir}/${pheno}_nofid.txt \
                --covar ${pheno_dir}/bcovariates_nofid.txt \
                --qcovar ${pheno_dir}/qcovariates_nofid.txt \
                --out ${results_dir}/morph_est_${atlasName}_${mod}_${pheno} \
                --reml-est-fix \
                --reml-maxit 10000
                
                echo &quot;Calculated morph estimate for $atlasName $mod $pheno&quot;
            else
                echo &quot;This already exists. Not running analysis.&quot; $mod $pheno
                continue
            fi
done

##### sbatch -p brc,shared ~/morphometricity/scripts/DK_calculate_morph_est_up.sh
</code></pre>
<hr />
<p><br> <br></p>
</div>
</div>
<div id="morphometricity-from-vertex-wise-data" class="section level1">
<h1>Morphometricity from vertex-wise data</h1>
<p><br></p>
<div id="make-bod-files-1" class="section level2">
<h2>1. Make bod files</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=vertex_bod
#SBATCH --output=~/morphometricity/output/vertices_make_bod_%A_%a.out
#SBATCH -D /mnt/lustre/datasets/ukbiobank/ukb40933/imaging/output
#SBATCH --mem-per-cpu=70G 
#SBATCH --array=1-3 # 3 modalities

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morph_results&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_meas.txt
meas=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)


##################################################
### OSCA analyses for brain vertices
### Step 1: get bod files
### Transposed format --tefile
##################################################
for hemi in rh lh
do

/users/k1894405/osca_Linux \
    --tefile ${wd}/data/vertices/${hemi}.${meas}_all_nodup_42999 \
    --make-bod \
    --no-fid \
    --sd-min 0.000001 \
    --out ${wd}/data/bod_files/Bod_vertices_${hemi}.${meas}
        
    
        ###########################################################################
        ## OSCA analyses: 
        ## manage bod files to include subset of individuals that all atlases &amp; vertices have in common
        ## Saved in indi.list
        ############################################################################

        /users/k1894405/osca_Linux \
        --befile ${wd}/data/bod_files/Bod_vertices_${hemi}.${meas} \
        --keep ${wd}/data/indi.list.fid \
        --make-bod \
        --out ${wd}/data/bod_files/Bod_vertices_${hemi}.${meas}
        
done


### sbatch -p shared,brc ~/morphometricity/scripts/vertices_make_bod.sh </code></pre>
<p><br></p>
</div>
<div id="calculate-brain-relatedness-matrix-per-hemisphere" class="section level2">
<h2>2. Calculate Brain-Relatedness-Matrix per hemisphere</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=vertex_BRM
#SBATCH --output=~/morphometricity/output/vertex_calculate_BRM_%A_%a.out
#SBATCH -D ~/morphometricity
#SBATCH --mem-per-cpu=200G 
#SBATCH --array=1-3 # 3 measurement types

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morph_results&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_meas.txt
meas=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)

echo &quot;Processing &quot; $meas

for hemi in lh rh
do
    if [ ! -f ${wd}/data/BRM/BRM_vertices_${hemi}.${meas}.orm.bin ]
    then
        ############################################################################
        # CALCULATE BRAIN-RELATEDNESS-MATRIX
        ############################################################################
        
        /users/k1894405/osca_Linux \
        --befile ${wd}/data/bod_files/Bod_vertices_${hemi}.${meas} \
        --make-orm \
        --out ${wd}/data/BRM/BRM_vertices_${hemi}.${meas}
        
        echo &quot;Calculated BRMs for ${hemi}.${meas}&quot;
        
        ############################################################################
        # GET MEAN AND VARIANCE FOR EACH ROI
        ############################################################################
        
        /users/k1894405/osca_Linux \            
        --befile ${wd}/data/bod_files/Bod_vertices_${hemi}.${meas} \
        --get-mean \
        --get-variance \
        --out ${wd}/bod_files/${hemi}.${meas}_mean_var
        
        echo &quot;Calculated mean and variances for ${hemi}.${meas}&quot;
    else
        echo ${hemi}.${meas} &quot; BRM already exists. Skipping.&quot;
    fi
done



#/usr/bin/sacct --format=&quot;CPUTime, MaxRSS&quot;

##### sbatch -p brc,shared ~/morphometricity/scripts/vertices_calculate_BRM.sh



##### This is the second step to get morphometricity estimates (after making bod files, before calculating morph estimates)</code></pre>
<p><br></p>
</div>
<div id="merge-brain-relatedness-matrix" class="section level2">
<h2>3. Merge Brain-Relatedness-Matrix</h2>
<pre class="r"><code>#!/bin/bash -l
#SBATCH --job-name=merge_vertexBRM
#SBATCH --output=~/morphometricity/output/merge_orm_vertex_%A_%a.out
#SBATCH -D ~/morphometricity
#SBATCH --mem=380
#SBATCH --exclusive
#SBATCH --array=1-3 # 3 ref files to merge

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morp_results_update&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_meas.txt
meas=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)



/users/k1894405/osca_Linux \
--befile-flist ${scripts_dir}/merge_${meas}.txt \
--make-bod \
--out ${wd}/data/bod_files/Bod_vertices_bothhemi_${meas}

echo &quot;Merging &quot; $meas

###########################################################################
# Keep participants of interest
##########################################################################
/users/k1894405/osca_Linux \
--befile ${wd}/data/bod_files/Bod_vertices_bothhemi_${meas} \
--keep ${wd}/data/indi.list.fid \
--make-bod \
--out ${wd}/data/bod_files/Bod_vertices_both.${meas}

############################################################################
# CALCULATE BRAIN-RELATEDNESS-MATRIX
############################################################################
        
    /users/k1894405/osca_Linux \
    --befile ${wd}/data/bod_files/Bod_vertices_bothhemi_${meas} \
    --make-orm \
    --out ${wd}/data/BRM/BRM_vertices_both.${meas}
        
    echo &quot;Calculated BRMs for ${meas}&quot;</code></pre>
<p><br></p>
</div>
<div id="get-morphometricity-estimate-1" class="section level2">
<h2>4. Get morphometricity estimate</h2>
<pre class="bash"><code>#!/bin/bash -l
#SBATCH --job-name=vertex_morph
#SBATCH --output=~/morphometricity/output/vertex_morph_%A_%a.out
#SBATCH -D ~/morphometricity
#####SBATCH --mem-per-cpu=300G
#SBATCH --mem=300G
#SBATCH --exclusive
#SBATCH --array=1-7 # 7 phenotypes

wd=&quot;~/morphometricity&quot;
pheno_dir=&quot;/mnt/lustre/datasets/ukbiobank/ukb40933/phenotypes&quot;
results_dir=&quot;~/morphometricity/results/morp_results_update&quot;
scripts_dir=&quot;~/morphometricity/scripts&quot;

refList=${scripts_dir}/ref_pheno.txt
pheno=$(awk &quot;FNR==$SLURM_ARRAY_TASK_ID&quot; $refList)



for meas in area volume thickness
do

echo &quot;Starting morph estimate $meas $pheno&quot;

if [ ! -f ${results_dir}/morph_est_vertices_${meas}_${pheno}.rsq ]
then
    #########################################
    ### Merge hemispheres for vertex BRM
    #########################################

    /users/k1894405/osca_Linux \
    --reml \
    --orm ${wd}/data/BRM/BRM_vertices_bothhemi_${meas} \
    --pheno ${pheno_dir}/${pheno}_nofid.txt \
    --covar ${pheno_dir}/bcovariates_nofid.txt \
    --qcovar ${pheno_dir}/qcovariates_nofid.txt \
    --out ${results_dir}/morph_est_vertices_${meas}_${pheno} \
    --reml-est-fix \
    --reml-maxit 10000

fi 

done 


##### sbatch -p brc,shared ~/morphometricity/scripts/vertices_get_morph_est.sh</code></pre>
<p><br> <br></p>
<hr />
</div>
</div>
<div id="detect-brm-outliers" class="section level1">
<h1>Detect BRM outliers</h1>
<p><br></p>
<p>Launch this Rscript (and specify the brain measurement type to be cleaned) in order to read in BRMs and detect outliers of participants that are too similar or dissimilar to the rest of the sample (BRM cut-off 8SDs). Based on this script, we excluded 4 participants altogether.</p>
<pre class="r"><code>args &lt;- commandArgs(trailingOnly = TRUE)

meas=args[1]
print(paste(&quot;Looking for outliers in &quot;, meas))


## define functions
## taken from Baptistes Github
## https://github.com/baptisteCD/Brain-LMM/blob/master/RR_4.0_BRM_QC_functions.R
## this may require ~220GB RAM

ReadORMBin=function(prefix, AllN=F, size=4){
  sum_i=function(i){
    return(sum(1:i))
  }
  BinFileName=paste(prefix,&quot;.orm.bin&quot;,sep=&quot;&quot;)
  NFileName=paste(prefix,&quot;.orm.N.bin&quot;,sep=&quot;&quot;)
  IDFileName=paste(prefix,&quot;.orm.id&quot;,sep=&quot;&quot;)
  id = read.table(IDFileName)
  n=dim(id)[1]
  BinFile=file(BinFileName, &quot;rb&quot;);
  grm=readBin(BinFile, n=n*(n+1)/2, what=numeric(0), size=size)
  NFile=file(NFileName, &quot;rb&quot;);
  if(AllN==T){
    N=readBin(NFile, n=n*(n+1)/2, what=numeric(0), size=size)
  }
  else N=readBin(NFile, n=1, what=numeric(0), size=size)
  i=sapply(1:n, sum_i)
  return(list(diag=grm[i], off=grm[-i], id=id, N=N))
}

# Format matrix
asBRM&lt;-function(BRMbin){
  mat&lt;-matrix(0, nrow = length(BRMbin$diag), ncol = length(BRMbin$diag))
mat[upper.tri(mat)]&lt;-BRMbin$off
mat&lt;-mat+t(mat)
diag(mat)&lt;-BRMbin$diag
colnames(mat)&lt;-BRMbin$id[,2]
rownames(mat)&lt;-BRMbin$id[,2]
  return(mat)
}

################################################################################################
setwd(&quot;/mnt/lustre/users/k1894405/morphometricity/data/BRM&quot;)

hemi = c(&quot;rh&quot;,&quot;lh&quot;)

for(i in meas){
    for(j in hemi){
        # read in BRM from binary file
        bin_mat &lt;- ReadORMBin(prefix=paste0(&quot;BRM_vertices_&quot;,j,&quot;.&quot;,i))
        
        # format as BRM
        mat &lt;- asBRM(BRMbin = bin_mat)
        
        # clean up
        rm(&quot;bin_mat&quot;)
        
        # calculate rowMeans to get average assoc of each participants with the rest of the sample
        rs &lt;- rowMeans(abs(mat))
        
        # clean up
        rm(&quot;mat&quot;)
        
        # extract Ids of participants whos rowMeans are outside of 8SDs
        outliers &lt;- names(rs[which(rs &gt; (mean(rs)+8*sd(rs)) ) ])
    
        # if outliers is not empty, save IDs to exclude from analysis
        if(length(outliers) &gt; 0){
            print(paste0(&quot;Outliers in &quot;,j,&quot;.&quot;,i,&quot; are printed in &quot;,&quot;IDs_BRM_outliers_&quot;,j,&quot;.&quot;,i,&quot;.txt&quot;)); write.table(outliers, paste0(&quot;IDs_BRM_outliers_&quot;,j,&quot;.&quot;,i,&quot;.txt&quot;), col.names = F, row.names = F, quote = F )
            }else{print(paste0(j,&quot;.&quot;,i,&quot; did not have any outliers&quot;))}
    }
}


print(&quot;Done identifying outliers for all atlases&quot;)</code></pre>
</div>

&nbsp;
<hr />
<a href = "https://www.kcl.ac.uk/">
<p style="text-align: center"><img src="KCL_logo.jpg" href="https://www.kcl.ac.uk/" style="width:70px;height:50px"> 
</a>
</p>

<a href = "https://www.kcl.ac.uk/people/anna-furtjes">
<p style="text-align: center;">By Anna Elisabeth Fürtjes</a></p>
<p style="text-align: center;"><span style="color: #808080;"><em>anna.furtjes@kcl.ac.uk</em></span></p>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Add font awesome icons -->
<p style="text-align: center;">
    <a href="https://twitter.com/Anna_Furtjes" class="fa fa-twitter"></a>
</p>

&nbsp;


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
